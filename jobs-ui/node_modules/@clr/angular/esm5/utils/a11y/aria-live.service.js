/*
 * Copyright (c) 2016-2019 VMware, Inc. All Rights Reserved.
 * This software is released under MIT license.
 * The full license information can be found in LICENSE in the root directory of this project.
 */
import * as tslib_1 from "tslib";
import { PLATFORM_ID } from '@angular/core';
import { DOCUMENT, isPlatformBrowser } from '@angular/common';
import { Inject, Injectable, NgZone } from '@angular/core';
import { uniqueIdFactory } from '../id-generator/id-generator.service';
export var AriaLivePoliteness;
(function (AriaLivePoliteness) {
    AriaLivePoliteness["off"] = "off";
    AriaLivePoliteness["polite"] = "polite";
    AriaLivePoliteness["assertive"] = "assertive";
})(AriaLivePoliteness || (AriaLivePoliteness = {}));
/**
 * Time in milliseconds before inserting the content into the container
 */
export var ARIA_LIVE_TICK = 100;
/**
 * This service handle `aria-live` accessibility attribute. The issue is that you need
 * to have the DOM Element with attribute `aria-live` before you could insert content
 * and SR (Screen Reader) pick the change and announce it.
 *
 * @remark
 * This is a private service, nothing here is part of Clarity's public API. It could change at any point in time.
 *
 * ```typescript
 * import { AriaLiveService } from 'src/clr-angular/utils/a11y/aria-live.service';
 *
 * @Component({
 * selector: 'clr-demo-component',
 * providers: [AriaLiveService],
 * template: `
 *   <ng-content></ng-content>
 * `,
 * })
 * export class DemoComponent {
 *  constructor(ariaLiveService: AriaLiveService) {}
 *
 *  public actionThatWillTriggerChange() {
 *    this.ariaLiveService.announce('message that I want to announce to SR');
 *  }
 * }
 * ```
 *
 */
var AriaLiveService = /** @class */ (function () {
    function AriaLiveService(ngZone, _document, platformId) {
        this.ngZone = ngZone;
        this.platformId = platformId;
        this._id = "clr-aria-live-element-" + uniqueIdFactory();
        this.document = _document;
    }
    Object.defineProperty(AriaLiveService.prototype, "id", {
        /**
         * get access to the internal HTML `id` that gonna be used for the AriaLive container.
         * @return ID of the DOM Element as string.
         */
        get: function () {
            return this._id;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Append text content inside the AriaLive Container. This method will check if the
     * DOM Element is existing if not it will create one for us and the will apply the text.
     *
     * ```typescript
     * this.ariaLiveService.announce(this.el.nativeElement);
     * // or
     * this.ariaLiveService.announce('Message to announce to SR');
     * ```
     *
     * @remark
     * When second argument is `AriaLivePoliteness.off` we won't create aria container or update it.
     * The reason for that is that we don't want to do additional work if the SR will ignore it.
     *
     * @param message - This could be simple string or HTMLElement
     * @param politeness - 'polite', 'assertive' or 'off'
     */
    AriaLiveService.prototype.announce = function (message, politeness) {
        var _this = this;
        if (politeness === void 0) { politeness = AriaLivePoliteness.polite; }
        if (politeness === AriaLivePoliteness.off) {
            return;
        }
        if (!this.ariaLiveElement && isPlatformBrowser(this.platformId)) {
            this.ariaLiveElement = this.createContainer();
        }
        message = typeof message !== 'string' && isPlatformBrowser(this.platformId) ? message.textContent : message;
        // when there is no message do NOTHING!
        if (!message) {
            return;
        }
        this.ariaLiveElement.setAttribute('aria-live', politeness);
        // This 100ms timeout is necessary for some browser + screen-reader combinations:
        // - Both JAWS and NVDA over IE11 will not announce anything without a non-zero timeout.
        // - With Chrome and IE11 with NVDA or JAWS, a repeated (identical) message won't be read a
        //   second time without clearing and then using a non-zero delay.
        // (using JAWS 17 at time of this writing).
        this.ngZone.runOutsideAngular(function () {
            // This clearTimeout will stop all older messages from announcing
            // in the case where the messages are comming too fast we gonna try to append only
            // the last one. That's what the SR will try to do anyway.
            clearTimeout(_this.previousTimeout);
            _this.previousTimeout = setTimeout(function () {
                _this.ariaLiveElement.textContent = message;
            }, ARIA_LIVE_TICK);
        });
    };
    /**
     * onDestroy life cycle - must stop all active setTimeouts and remove the AriaLive
     * container from the document.
     */
    AriaLiveService.prototype.ngOnDestroy = function () {
        clearTimeout(this.previousTimeout);
        if (isPlatformBrowser(this.platformId) && this.ariaLiveElement) {
            this.document.body.removeChild(this.ariaLiveElement);
            this.ariaLiveElement = null;
        }
    };
    /**
     * Create AriaLive DOM element as a last child of the document.
     * After the element is created, we gonna apply Clarity class to hide it from
     * the screen and set the `aria-live` politness.
     *
     * `clr-sr-only` is the CSS class that is used to hide the element from the screen.
     *
     * @remark
     * Calling this method multiple times will create multiple DOM Elements, that
     * won't be tracked and will be GC after the service is destroyed.
     *
     * @return AriaLive container as HTMLElement
     *
     */
    AriaLiveService.prototype.createContainer = function () {
        var ariaLiveElement = this.document.createElement('div');
        ariaLiveElement.setAttribute('id', this.id);
        // Use clarity screen reader class to hide the dom element
        // and fix the scrollbar shake
        ariaLiveElement.classList.add('clr-sr-only');
        ariaLiveElement.setAttribute('aria-atomic', 'true');
        ariaLiveElement.setAttribute('aria-live', AriaLivePoliteness.polite);
        this.document.body.appendChild(ariaLiveElement);
        return ariaLiveElement;
    };
    AriaLiveService = tslib_1.__decorate([
        Injectable(),
        tslib_1.__param(1, Inject(DOCUMENT)),
        tslib_1.__param(2, Inject(PLATFORM_ID)),
        tslib_1.__metadata("design:paramtypes", [NgZone, Object, Object])
    ], AriaLiveService);
    return AriaLiveService;
}());
export { AriaLiveService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXJpYS1saXZlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AY2xyL2FuZ3VsYXIvIiwic291cmNlcyI6WyJ1dGlscy9hMTF5L2FyaWEtbGl2ZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7O0dBSUc7O0FBRUgsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM1QyxPQUFPLEVBQUUsUUFBUSxFQUFFLGlCQUFpQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDOUQsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFhLE1BQU0sZUFBZSxDQUFDO0FBQ3RFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxzQ0FBc0MsQ0FBQztBQUV2RSxNQUFNLENBQU4sSUFBWSxrQkFJWDtBQUpELFdBQVksa0JBQWtCO0lBQzVCLGlDQUFXLENBQUE7SUFDWCx1Q0FBaUIsQ0FBQTtJQUNqQiw2Q0FBdUIsQ0FBQTtBQUN6QixDQUFDLEVBSlcsa0JBQWtCLEtBQWxCLGtCQUFrQixRQUk3QjtBQUVEOztHQUVHO0FBQ0gsTUFBTSxDQUFDLElBQU0sY0FBYyxHQUFXLEdBQUcsQ0FBQztBQUUxQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBMkJHO0FBRUg7SUFLRSx5QkFDVSxNQUFjLEVBQ0osU0FBYyxFQUNILFVBQWtCO1FBRnZDLFdBQU0sR0FBTixNQUFNLENBQVE7UUFFTyxlQUFVLEdBQVYsVUFBVSxDQUFRO1FBS3pDLFFBQUcsR0FBVywyQkFBeUIsZUFBZSxFQUFJLENBQUM7UUFIakUsSUFBSSxDQUFDLFFBQVEsR0FBRyxTQUFTLENBQUM7SUFDNUIsQ0FBQztJQU9ELHNCQUFXLCtCQUFFO1FBSmI7OztXQUdHO2FBQ0g7WUFDRSxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUM7UUFDbEIsQ0FBQzs7O09BQUE7SUFFRDs7Ozs7Ozs7Ozs7Ozs7OztPQWdCRztJQUNJLGtDQUFRLEdBQWYsVUFBZ0IsT0FBNkIsRUFBRSxVQUEwRDtRQUF6RyxpQkFnQ0M7UUFoQzhDLDJCQUFBLEVBQUEsYUFBaUMsa0JBQWtCLENBQUMsTUFBTTtRQUN2RyxJQUFJLFVBQVUsS0FBSyxrQkFBa0IsQ0FBQyxHQUFHLEVBQUU7WUFDekMsT0FBTztTQUNSO1FBRUQsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLElBQUksaUJBQWlCLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFO1lBQy9ELElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1NBQy9DO1FBRUQsT0FBTyxHQUFHLE9BQU8sT0FBTyxLQUFLLFFBQVEsSUFBSSxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztRQUU1Ryx1Q0FBdUM7UUFDdkMsSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNaLE9BQU87U0FDUjtRQUVELElBQUksQ0FBQyxlQUFlLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxVQUFVLENBQUMsQ0FBQztRQUUzRCxpRkFBaUY7UUFDakYsd0ZBQXdGO1FBQ3hGLDJGQUEyRjtRQUMzRixrRUFBa0U7UUFDbEUsMkNBQTJDO1FBQzNDLElBQUksQ0FBQyxNQUFNLENBQUMsaUJBQWlCLENBQUM7WUFDNUIsaUVBQWlFO1lBQ2pFLGtGQUFrRjtZQUNsRiwwREFBMEQ7WUFDMUQsWUFBWSxDQUFDLEtBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztZQUNuQyxLQUFJLENBQUMsZUFBZSxHQUFHLFVBQVUsQ0FBQztnQkFDaEMsS0FBSSxDQUFDLGVBQWUsQ0FBQyxXQUFXLEdBQVcsT0FBTyxDQUFDO1lBQ3JELENBQUMsRUFBRSxjQUFjLENBQUMsQ0FBQztRQUNyQixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7O09BR0c7SUFDSSxxQ0FBVyxHQUFsQjtRQUNFLFlBQVksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7UUFFbkMsSUFBSSxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksSUFBSSxDQUFDLGVBQWUsRUFBRTtZQUM5RCxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBQ3JELElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDO1NBQzdCO0lBQ0gsQ0FBQztJQUVEOzs7Ozs7Ozs7Ozs7O09BYUc7SUFDSyx5Q0FBZSxHQUF2QjtRQUNFLElBQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRTNELGVBQWUsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM1QywwREFBMEQ7UUFDMUQsOEJBQThCO1FBQzlCLGVBQWUsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRTdDLGVBQWUsQ0FBQyxZQUFZLENBQUMsYUFBYSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ3BELGVBQWUsQ0FBQyxZQUFZLENBQUMsV0FBVyxFQUFFLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRXJFLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUVoRCxPQUFPLGVBQWUsQ0FBQztJQUN6QixDQUFDO0lBbEhVLGVBQWU7UUFEM0IsVUFBVSxFQUFFO1FBUVIsbUJBQUEsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFBO1FBQ2hCLG1CQUFBLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQTtpREFGSixNQUFNLFVBRW1CLE1BQU07T0FSdEMsZUFBZSxDQW1IM0I7SUFBRCxzQkFBQztDQUFBLEFBbkhELElBbUhDO1NBbkhZLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IChjKSAyMDE2LTIwMTkgVk13YXJlLCBJbmMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKiBUaGlzIHNvZnR3YXJlIGlzIHJlbGVhc2VkIHVuZGVyIE1JVCBsaWNlbnNlLlxuICogVGhlIGZ1bGwgbGljZW5zZSBpbmZvcm1hdGlvbiBjYW4gYmUgZm91bmQgaW4gTElDRU5TRSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBwcm9qZWN0LlxuICovXG5cbmltcG9ydCB7IFBMQVRGT1JNX0lEIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBET0NVTUVOVCwgaXNQbGF0Zm9ybUJyb3dzZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBOZ1pvbmUsIE9uRGVzdHJveSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgdW5pcXVlSWRGYWN0b3J5IH0gZnJvbSAnLi4vaWQtZ2VuZXJhdG9yL2lkLWdlbmVyYXRvci5zZXJ2aWNlJztcblxuZXhwb3J0IGVudW0gQXJpYUxpdmVQb2xpdGVuZXNzIHtcbiAgb2ZmID0gJ29mZicsXG4gIHBvbGl0ZSA9ICdwb2xpdGUnLFxuICBhc3NlcnRpdmUgPSAnYXNzZXJ0aXZlJyxcbn1cblxuLyoqXG4gKiBUaW1lIGluIG1pbGxpc2Vjb25kcyBiZWZvcmUgaW5zZXJ0aW5nIHRoZSBjb250ZW50IGludG8gdGhlIGNvbnRhaW5lclxuICovXG5leHBvcnQgY29uc3QgQVJJQV9MSVZFX1RJQ0s6IG51bWJlciA9IDEwMDtcblxuLyoqXG4gKiBUaGlzIHNlcnZpY2UgaGFuZGxlIGBhcmlhLWxpdmVgIGFjY2Vzc2liaWxpdHkgYXR0cmlidXRlLiBUaGUgaXNzdWUgaXMgdGhhdCB5b3UgbmVlZFxuICogdG8gaGF2ZSB0aGUgRE9NIEVsZW1lbnQgd2l0aCBhdHRyaWJ1dGUgYGFyaWEtbGl2ZWAgYmVmb3JlIHlvdSBjb3VsZCBpbnNlcnQgY29udGVudFxuICogYW5kIFNSIChTY3JlZW4gUmVhZGVyKSBwaWNrIHRoZSBjaGFuZ2UgYW5kIGFubm91bmNlIGl0LlxuICpcbiAqIEByZW1hcmtcbiAqIFRoaXMgaXMgYSBwcml2YXRlIHNlcnZpY2UsIG5vdGhpbmcgaGVyZSBpcyBwYXJ0IG9mIENsYXJpdHkncyBwdWJsaWMgQVBJLiBJdCBjb3VsZCBjaGFuZ2UgYXQgYW55IHBvaW50IGluIHRpbWUuXG4gKlxuICogYGBgdHlwZXNjcmlwdFxuICogaW1wb3J0IHsgQXJpYUxpdmVTZXJ2aWNlIH0gZnJvbSAnc3JjL2Nsci1hbmd1bGFyL3V0aWxzL2ExMXkvYXJpYS1saXZlLnNlcnZpY2UnO1xuICpcbiAqIEBDb21wb25lbnQoe1xuICogc2VsZWN0b3I6ICdjbHItZGVtby1jb21wb25lbnQnLFxuICogcHJvdmlkZXJzOiBbQXJpYUxpdmVTZXJ2aWNlXSxcbiAqIHRlbXBsYXRlOiBgXG4gKiAgIDxuZy1jb250ZW50PjwvbmctY29udGVudD5cbiAqIGAsXG4gKiB9KVxuICogZXhwb3J0IGNsYXNzIERlbW9Db21wb25lbnQge1xuICogIGNvbnN0cnVjdG9yKGFyaWFMaXZlU2VydmljZTogQXJpYUxpdmVTZXJ2aWNlKSB7fVxuICpcbiAqICBwdWJsaWMgYWN0aW9uVGhhdFdpbGxUcmlnZ2VyQ2hhbmdlKCkge1xuICogICAgdGhpcy5hcmlhTGl2ZVNlcnZpY2UuYW5ub3VuY2UoJ21lc3NhZ2UgdGhhdCBJIHdhbnQgdG8gYW5ub3VuY2UgdG8gU1InKTtcbiAqICB9XG4gKiB9XG4gKiBgYGBcbiAqXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBBcmlhTGl2ZVNlcnZpY2UgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xuICBwcml2YXRlIGFyaWFMaXZlRWxlbWVudDogSFRNTEVsZW1lbnQ7XG4gIHByaXZhdGUgZG9jdW1lbnQ6IERvY3VtZW50O1xuICBwcml2YXRlIHByZXZpb3VzVGltZW91dDogUmV0dXJuVHlwZTx0eXBlb2Ygc2V0VGltZW91dD47XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBuZ1pvbmU6IE5nWm9uZSxcbiAgICBASW5qZWN0KERPQ1VNRU5UKSBfZG9jdW1lbnQ6IGFueSxcbiAgICBASW5qZWN0KFBMQVRGT1JNX0lEKSBwcml2YXRlIHBsYXRmb3JtSWQ6IE9iamVjdFxuICApIHtcbiAgICB0aGlzLmRvY3VtZW50ID0gX2RvY3VtZW50O1xuICB9XG5cbiAgcHJpdmF0ZSBfaWQ6IHN0cmluZyA9IGBjbHItYXJpYS1saXZlLWVsZW1lbnQtJHt1bmlxdWVJZEZhY3RvcnkoKX1gO1xuICAvKipcbiAgICogZ2V0IGFjY2VzcyB0byB0aGUgaW50ZXJuYWwgSFRNTCBgaWRgIHRoYXQgZ29ubmEgYmUgdXNlZCBmb3IgdGhlIEFyaWFMaXZlIGNvbnRhaW5lci5cbiAgICogQHJldHVybiBJRCBvZiB0aGUgRE9NIEVsZW1lbnQgYXMgc3RyaW5nLlxuICAgKi9cbiAgcHVibGljIGdldCBpZCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLl9pZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBBcHBlbmQgdGV4dCBjb250ZW50IGluc2lkZSB0aGUgQXJpYUxpdmUgQ29udGFpbmVyLiBUaGlzIG1ldGhvZCB3aWxsIGNoZWNrIGlmIHRoZVxuICAgKiBET00gRWxlbWVudCBpcyBleGlzdGluZyBpZiBub3QgaXQgd2lsbCBjcmVhdGUgb25lIGZvciB1cyBhbmQgdGhlIHdpbGwgYXBwbHkgdGhlIHRleHQuXG4gICAqXG4gICAqIGBgYHR5cGVzY3JpcHRcbiAgICogdGhpcy5hcmlhTGl2ZVNlcnZpY2UuYW5ub3VuY2UodGhpcy5lbC5uYXRpdmVFbGVtZW50KTtcbiAgICogLy8gb3JcbiAgICogdGhpcy5hcmlhTGl2ZVNlcnZpY2UuYW5ub3VuY2UoJ01lc3NhZ2UgdG8gYW5ub3VuY2UgdG8gU1InKTtcbiAgICogYGBgXG4gICAqXG4gICAqIEByZW1hcmtcbiAgICogV2hlbiBzZWNvbmQgYXJndW1lbnQgaXMgYEFyaWFMaXZlUG9saXRlbmVzcy5vZmZgIHdlIHdvbid0IGNyZWF0ZSBhcmlhIGNvbnRhaW5lciBvciB1cGRhdGUgaXQuXG4gICAqIFRoZSByZWFzb24gZm9yIHRoYXQgaXMgdGhhdCB3ZSBkb24ndCB3YW50IHRvIGRvIGFkZGl0aW9uYWwgd29yayBpZiB0aGUgU1Igd2lsbCBpZ25vcmUgaXQuXG4gICAqXG4gICAqIEBwYXJhbSBtZXNzYWdlIC0gVGhpcyBjb3VsZCBiZSBzaW1wbGUgc3RyaW5nIG9yIEhUTUxFbGVtZW50XG4gICAqIEBwYXJhbSBwb2xpdGVuZXNzIC0gJ3BvbGl0ZScsICdhc3NlcnRpdmUnIG9yICdvZmYnXG4gICAqL1xuICBwdWJsaWMgYW5ub3VuY2UobWVzc2FnZTogc3RyaW5nIHwgSFRNTEVsZW1lbnQsIHBvbGl0ZW5lc3M6IEFyaWFMaXZlUG9saXRlbmVzcyA9IEFyaWFMaXZlUG9saXRlbmVzcy5wb2xpdGUpOiB2b2lkIHtcbiAgICBpZiAocG9saXRlbmVzcyA9PT0gQXJpYUxpdmVQb2xpdGVuZXNzLm9mZikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5hcmlhTGl2ZUVsZW1lbnQgJiYgaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5wbGF0Zm9ybUlkKSkge1xuICAgICAgdGhpcy5hcmlhTGl2ZUVsZW1lbnQgPSB0aGlzLmNyZWF0ZUNvbnRhaW5lcigpO1xuICAgIH1cblxuICAgIG1lc3NhZ2UgPSB0eXBlb2YgbWVzc2FnZSAhPT0gJ3N0cmluZycgJiYgaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5wbGF0Zm9ybUlkKSA/IG1lc3NhZ2UudGV4dENvbnRlbnQgOiBtZXNzYWdlO1xuXG4gICAgLy8gd2hlbiB0aGVyZSBpcyBubyBtZXNzYWdlIGRvIE5PVEhJTkchXG4gICAgaWYgKCFtZXNzYWdlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5hcmlhTGl2ZUVsZW1lbnQuc2V0QXR0cmlidXRlKCdhcmlhLWxpdmUnLCBwb2xpdGVuZXNzKTtcblxuICAgIC8vIFRoaXMgMTAwbXMgdGltZW91dCBpcyBuZWNlc3NhcnkgZm9yIHNvbWUgYnJvd3NlciArIHNjcmVlbi1yZWFkZXIgY29tYmluYXRpb25zOlxuICAgIC8vIC0gQm90aCBKQVdTIGFuZCBOVkRBIG92ZXIgSUUxMSB3aWxsIG5vdCBhbm5vdW5jZSBhbnl0aGluZyB3aXRob3V0IGEgbm9uLXplcm8gdGltZW91dC5cbiAgICAvLyAtIFdpdGggQ2hyb21lIGFuZCBJRTExIHdpdGggTlZEQSBvciBKQVdTLCBhIHJlcGVhdGVkIChpZGVudGljYWwpIG1lc3NhZ2Ugd29uJ3QgYmUgcmVhZCBhXG4gICAgLy8gICBzZWNvbmQgdGltZSB3aXRob3V0IGNsZWFyaW5nIGFuZCB0aGVuIHVzaW5nIGEgbm9uLXplcm8gZGVsYXkuXG4gICAgLy8gKHVzaW5nIEpBV1MgMTcgYXQgdGltZSBvZiB0aGlzIHdyaXRpbmcpLlxuICAgIHRoaXMubmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgIC8vIFRoaXMgY2xlYXJUaW1lb3V0IHdpbGwgc3RvcCBhbGwgb2xkZXIgbWVzc2FnZXMgZnJvbSBhbm5vdW5jaW5nXG4gICAgICAvLyBpbiB0aGUgY2FzZSB3aGVyZSB0aGUgbWVzc2FnZXMgYXJlIGNvbW1pbmcgdG9vIGZhc3Qgd2UgZ29ubmEgdHJ5IHRvIGFwcGVuZCBvbmx5XG4gICAgICAvLyB0aGUgbGFzdCBvbmUuIFRoYXQncyB3aGF0IHRoZSBTUiB3aWxsIHRyeSB0byBkbyBhbnl3YXkuXG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5wcmV2aW91c1RpbWVvdXQpO1xuICAgICAgdGhpcy5wcmV2aW91c1RpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgdGhpcy5hcmlhTGl2ZUVsZW1lbnQudGV4dENvbnRlbnQgPSA8c3RyaW5nPm1lc3NhZ2U7XG4gICAgICB9LCBBUklBX0xJVkVfVElDSyk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogb25EZXN0cm95IGxpZmUgY3ljbGUgLSBtdXN0IHN0b3AgYWxsIGFjdGl2ZSBzZXRUaW1lb3V0cyBhbmQgcmVtb3ZlIHRoZSBBcmlhTGl2ZVxuICAgKiBjb250YWluZXIgZnJvbSB0aGUgZG9jdW1lbnQuXG4gICAqL1xuICBwdWJsaWMgbmdPbkRlc3Ryb3koKSB7XG4gICAgY2xlYXJUaW1lb3V0KHRoaXMucHJldmlvdXNUaW1lb3V0KTtcblxuICAgIGlmIChpc1BsYXRmb3JtQnJvd3Nlcih0aGlzLnBsYXRmb3JtSWQpICYmIHRoaXMuYXJpYUxpdmVFbGVtZW50KSB7XG4gICAgICB0aGlzLmRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5hcmlhTGl2ZUVsZW1lbnQpO1xuICAgICAgdGhpcy5hcmlhTGl2ZUVsZW1lbnQgPSBudWxsO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgQXJpYUxpdmUgRE9NIGVsZW1lbnQgYXMgYSBsYXN0IGNoaWxkIG9mIHRoZSBkb2N1bWVudC5cbiAgICogQWZ0ZXIgdGhlIGVsZW1lbnQgaXMgY3JlYXRlZCwgd2UgZ29ubmEgYXBwbHkgQ2xhcml0eSBjbGFzcyB0byBoaWRlIGl0IGZyb21cbiAgICogdGhlIHNjcmVlbiBhbmQgc2V0IHRoZSBgYXJpYS1saXZlYCBwb2xpdG5lc3MuXG4gICAqXG4gICAqIGBjbHItc3Itb25seWAgaXMgdGhlIENTUyBjbGFzcyB0aGF0IGlzIHVzZWQgdG8gaGlkZSB0aGUgZWxlbWVudCBmcm9tIHRoZSBzY3JlZW4uXG4gICAqXG4gICAqIEByZW1hcmtcbiAgICogQ2FsbGluZyB0aGlzIG1ldGhvZCBtdWx0aXBsZSB0aW1lcyB3aWxsIGNyZWF0ZSBtdWx0aXBsZSBET00gRWxlbWVudHMsIHRoYXRcbiAgICogd29uJ3QgYmUgdHJhY2tlZCBhbmQgd2lsbCBiZSBHQyBhZnRlciB0aGUgc2VydmljZSBpcyBkZXN0cm95ZWQuXG4gICAqXG4gICAqIEByZXR1cm4gQXJpYUxpdmUgY29udGFpbmVyIGFzIEhUTUxFbGVtZW50XG4gICAqXG4gICAqL1xuICBwcml2YXRlIGNyZWF0ZUNvbnRhaW5lcigpOiBIVE1MRWxlbWVudCB7XG4gICAgY29uc3QgYXJpYUxpdmVFbGVtZW50ID0gdGhpcy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcblxuICAgIGFyaWFMaXZlRWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2lkJywgdGhpcy5pZCk7XG4gICAgLy8gVXNlIGNsYXJpdHkgc2NyZWVuIHJlYWRlciBjbGFzcyB0byBoaWRlIHRoZSBkb20gZWxlbWVudFxuICAgIC8vIGFuZCBmaXggdGhlIHNjcm9sbGJhciBzaGFrZVxuICAgIGFyaWFMaXZlRWxlbWVudC5jbGFzc0xpc3QuYWRkKCdjbHItc3Itb25seScpO1xuXG4gICAgYXJpYUxpdmVFbGVtZW50LnNldEF0dHJpYnV0ZSgnYXJpYS1hdG9taWMnLCAndHJ1ZScpO1xuICAgIGFyaWFMaXZlRWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2FyaWEtbGl2ZScsIEFyaWFMaXZlUG9saXRlbmVzcy5wb2xpdGUpO1xuXG4gICAgdGhpcy5kb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGFyaWFMaXZlRWxlbWVudCk7XG5cbiAgICByZXR1cm4gYXJpYUxpdmVFbGVtZW50O1xuICB9XG59XG4iXX0=